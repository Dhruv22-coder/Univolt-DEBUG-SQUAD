<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Univolt | Network Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap');
        * { box-sizing: border-box; }
        body { background: #000; color: white; font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Styles */
        .sidebar { width: 350px; background: #0a0a0a; border-right: 1px solid #1a1a1a; display: flex; flex-direction: column; }
        #contacts-container { flex: 1; overflow-y: auto; padding: 12px; }
        
        .contact-item { 
            padding: 12px 16px; border-radius: 16px; margin-bottom: 6px; cursor: pointer; transition: 0.2s;
            border: 1px solid transparent; display: flex; align-items: center; gap: 12px;
        }
        .contact-item.active { background: #1a1a1a; border-color: #f59e0b; }

        /* Chat Window Styles */
        .chat-window { flex: 1; display: flex; flex-direction: column; background: #050505; }
        
        #messages-box { 
            flex: 1; padding: 25px; overflow-y: auto; 
            display: flex; flex-direction: column;
            background-image: radial-gradient(#111 1px, transparent 1px); background-size: 20px 20px; 
        }
        
        .bubble { 
            padding: 10px 16px; border-radius: 18px; max-width: 70%; 
            font-size: 14px; line-height: 1.4; word-wrap: break-word; 
            margin-bottom: 8px; position: relative;
        }
        
        .sent { 
            align-self: flex-end; background: #f59e0b; color: black; font-weight: 600; 
            border-bottom-right-radius: 2px;
        }

        .received { 
            align-self: flex-start; background: #1a1a1a; border: 1px solid #262626; 
            color: #eee; border-bottom-left-radius: 2px;
        }

        .time { font-size: 9px; margin-top: 4px; opacity: 0.5; font-weight: bold; }
        .input-area { padding: 20px; background: #0a0a0a; border-top: 1px solid #1a1a1a; display: flex; gap: 12px; }
        input { flex: 1; background: #141414; border: 1px solid #262626; padding: 14px 20px; color: white; border-radius: 12px; outline: none; }
        .send-btn { background: #f59e0b; color: black; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #262626; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-6 border-b border-zinc-900 flex flex-col gap-4">
            <button onclick="window.history.back()" class="flex items-center gap-2 text-zinc-500 hover:text-orange-500 transition-all mb-2">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                <span class="text-[9px] font-black uppercase tracking-widest">Back to Network</span>
            </button>
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-black italic uppercase tracking-tighter text-orange-500">Univolt</h2>
                    <p class="text-[9px] text-zinc-500 font-bold uppercase tracking-[0.2em]">Network Chat</p>
                </div>
                <i data-lucide="message-circle" class="text-orange-500 w-5 h-5"></i>
            </div>
            <div class="relative mt-2">
                <input type="text" id="locSearch" placeholder="SEARCH BY LOCATION..." 
                    class="w-full bg-zinc-900 border border-zinc-800 p-2 rounded-lg text-[8px] font-black text-white outline-none focus:border-orange-500 pl-8">
                <i data-lucide="map-pin" class="w-3 h-3 absolute left-2.5 top-2.5 text-zinc-600"></i>
            </div>
        </div>

        <div id="contacts-container"></div>

        <div class="p-4 border-t border-zinc-900">
            <button id="toggle-directory" class="w-full bg-orange-500/10 hover:bg-orange-500 hover:text-black text-orange-500 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">
                Search All Unibros
            </button>
        </div>
    </div>

    <div class="chat-window">
        <div id="chat-header" class="p-4 border-b border-zinc-900 flex items-center gap-3 bg-black/50 backdrop-blur-md">
            <div id="partner-avatar" class="w-10 h-10 rounded-full bg-zinc-800 border border-zinc-700 flex items-center justify-center text-orange-500 font-black">?</div>
            <div>
                <div id="active-partner" class="text-xs font-black uppercase tracking-wider">Select Contact</div>
                <div id="status-indicator" class="text-[9px] text-zinc-500 font-bold uppercase">Standby</div>
            </div>
        </div>

        <div id="messages-box"></div>

        <div class="input-area">
            <input type="text" id="message-input" placeholder="Type a message..." disabled autocomplete="off">
            <button id="send-btn" class="send-btn" disabled><i data-lucide="send" class="w-5 h-5"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, get, off, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBiUgLhheSZfbUb3_iR9BXXE0egguhaeII",
            authDomain: "univolt-55ccc.firebaseapp.com",
            databaseURL: "https://univolt-55ccc-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "univolt-55ccc",
            appId: "1:222559597781:web:86482a1f73314092371e5c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        lucide.createIcons();

        let myUid, activeChatId, currentPartnerId;
        let isShowingDirectory = false;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                myUid = String(user.uid);
                onValue(ref(db, 'users'), renderSidebar);
                onValue(ref(db, 'chats'), renderSidebar);
            }
        });

        // Search logic
        document.getElementById('locSearch').oninput = (e) => {
            const term = e.target.value.toLowerCase();
            const items = document.querySelectorAll('.contact-item');
            items.forEach(item => {
                const location = item.getAttribute('data-location').toLowerCase();
                item.style.display = location.includes(term) ? 'flex' : 'none';
            });
        };

        async function renderSidebar() {
            if (!myUid) return;
            const container = document.getElementById('contacts-container');
            const users = (await get(ref(db, 'users'))).val() || {};
            const chats = (await get(ref(db, 'chats'))).val() || {};
            const activeIds = new Set();

            Object.keys(chats).forEach(id => {
                if (id.includes(myUid)) {
                    const parts = id.split('_');
                    activeIds.add(parts[0] === myUid ? parts[1] : parts[0]);
                }
            });

            container.innerHTML = '';
            Object.keys(users).forEach(id => {
                if (id === myUid) return;
                if (!isShowingDirectory && !activeIds.has(id)) return;
                
                const u = users[id];
                const name = (u.name || "Anonymous").toUpperCase();
                const location = u.location || "Unknown";
                
                const item = document.createElement('div');
                item.className = `contact-item ${currentPartnerId === id ? 'active' : ''}`;
                item.setAttribute('data-location', location);
                item.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-zinc-900 border border-zinc-800 flex items-center justify-center text-orange-500 font-bold text-xs">${name[0]}</div>
                    <div>
                        <div class="text-[11px] font-black text-white">${name}</div>
                        <div class="text-[7px] text-zinc-500 font-bold uppercase tracking-widest">${location} | ${u.role || 'NODE'}</div>
                    </div>
                `;
                item.onclick = () => startChat(id, name);
                container.appendChild(item);
            });
        }

        function startChat(partnerId, partnerName) {
            if (activeChatId) off(ref(db, `chats/${activeChatId}`));
            currentPartnerId = partnerId;
            activeChatId = myUid < partnerId ? `${myUid}_${partnerId}` : `${partnerId}_${myUid}`;

            document.getElementById('active-partner').innerText = partnerName;
            document.getElementById('partner-avatar').innerText = partnerName[0];
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('status-indicator').innerText = "Encrypted Connection Stable";

            const box = document.getElementById('messages-box');
            box.innerHTML = '';

            onChildAdded(ref(db, `chats/${activeChatId}`), (snap) => {
                const data = snap.val();
                const isMe = String(data.sender) === String(myUid);

                const bubble = document.createElement('div');
                bubble.className = `bubble ${isMe ? 'sent' : 'received'}`;
                bubble.innerHTML = `
                    <div>${data.text}</div>
                    <div class="time">${new Date(data.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                `;
                box.appendChild(bubble);
                box.scrollTop = box.scrollHeight;
            });
            renderSidebar();
        }

        function broadcast() {
            const input = document.getElementById('message-input');
            const msg = input.value.trim();
            if (!msg || !activeChatId) return;
            push(ref(db, `chats/${activeChatId}`), {
                sender: String(myUid),
                text: msg,
                timestamp: Date.now()
            });
            input.value = '';
        }

        document.getElementById('send-btn').onclick = broadcast;
        document.getElementById('message-input').onkeypress = (e) => { if(e.key === 'Enter') broadcast(); };
        document.getElementById('toggle-directory').onclick = () => { 
            isShowingDirectory = !isShowingDirectory; 
            document.getElementById('toggle-directory').innerText = isShowingDirectory ? "Show Active Chats" : "Search All Unibros";
            renderSidebar(); 
        };
    </script>
</body>
</html>