<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Univolt | Smart Alumni Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cyber-card { background-color: black; backdrop-filter: blur(15px); border: 1px solid rgba(245, 158, 11, 0.2); box-shadow: 0 0 30px rgba(0, 0, 0, 0.7); }
        @keyframes flow { 0% { transform: translateX(-150%) skewX(-25deg); } 100% { transform: translateX(150%) skewX(-25deg); } }
        .glow-flow { position: relative; overflow: hidden; }
        .glow-flow::after { content: ""; position: absolute; top: 0; left: 0; width: 50%; height: 100%; background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.3), transparent); animation: flow 2.5s infinite linear; }
        .logo-glow { filter: drop-shadow(0 0 15px rgba(245, 158, 11, 0.6)); transition: transform 0.3s ease; }
        .spinner { border: 3px solid rgba(245, 158, 11, 0.1); border-top: 3px solid #f59e0b; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-black via-zinc-900 to-orange-950 min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="cyber-card w-full max-w-md p-8 rounded-2xl relative overflow-hidden">
        <div class="text-center mb-8 relative z-10">
            <div class="flex justify-center mb-6">
                <img src="image1.png" alt="Univolt Logo" class="w-28 h-28 object-contain logo-glow">
            </div>
            <h1 id="form-title" class="text-3xl font-bold text-white uppercase tracking-tighter">Log into Univolt</h1>
        </div>

        <form id="auth-form" class="relative z-10">
            <div id="role-selector" class="hidden mb-6">
                <label class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-3 block opacity-70">Identity Protocol</label>
                <div class="grid grid-cols-1 gap-2">
                    <button type="button" onclick="setRole('unibro')" id="btn-unibro" class="role-btn glow-flow flex justify-between items-center px-4 py-3 rounded-lg border border-orange-500 bg-orange-500 text-black font-bold transition-all">
                        <span>UNIBRO</span> <span class="text-[10px] opacity-70 uppercase font-black">Student</span>
                    </button>
                    <button type="button" onclick="setRole('unimate')" id="btn-unimate" class="role-btn flex justify-between items-center px-4 py-3 rounded-lg border border-zinc-700 text-zinc-400 font-bold hover:border-orange-500/50 transition-all">
                        <span>UNIMATE</span> <span class="text-[10px] opacity-70 uppercase font-black">Alumni</span>
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full px-4 py-3 rounded-lg bg-zinc-900 border border-zinc-800 text-white focus:border-orange-500 focus:outline-none transition-all" required>
                <div id="extra-fields" class="space-y-4 hidden">
                    <input id="role-specific-input" type="text" placeholder="Registration/ID Number" class="w-full px-4 py-3 rounded-lg bg-zinc-900 border border-zinc-800 text-white focus:border-orange-500 focus:outline-none transition-all">
                </div>
                <input type="password" id="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg bg-zinc-900 border border-zinc-800 text-white focus:border-orange-500 focus:outline-none transition-all" required>
            </div>

            <div id="submit-container" class="mt-6">
                <button type="submit" id="submit-btn" class="glow-flow w-full bg-orange-500 hover:bg-orange-400 text-black font-black py-4 rounded-lg flex justify-center items-center gap-3 transition-all active:scale-95 uppercase tracking-widest shadow-lg shadow-orange-500/20">
                    <span id="btn-text">Sign In</span>
                    <div id="loader" class="spinner"></div>
                </button>
            </div>
        </form>

        <div class="mt-8 text-center">
            <button onclick="toggleAuth()" id="toggle-text" class="text-xs text-zinc-500 tracking-widest uppercase">
                New User? <span class="text-orange-500 font-black hover:underline cursor-pointer">Sign Up</span>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBiUgLhheSZfbUb3_iR9BXXE0egguhaeII",
            authDomain: "univolt-55ccc.firebaseapp.com",
            databaseURL: "https://univolt-55ccc-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "univolt-55ccc",
            appId: "1:222559597781:web:86482a1f73314092371e5c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let isLogin = true;
        let selectedRole = 'unibro';

        window.toggleAuth = () => {
            isLogin = !isLogin;
            document.getElementById('form-title').innerText = isLogin ? "Log into Univolt" : "Register for Univolt";
            document.getElementById('role-selector').classList.toggle('hidden');
            document.getElementById('extra-fields').classList.toggle('hidden');
            document.getElementById('btn-text').innerText = isLogin ? "Sign In" : "Create Identity";
            document.getElementById('toggle-text').innerHTML = isLogin ? 'New User? <span class="text-orange-500 font-black">Sign Up</span>' : 'Existing Member? <span class="text-orange-500 font-black">Sign In</span>';
        };

        window.setRole = (role) => {
            selectedRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.className = "role-btn flex justify-between items-center px-4 py-3 rounded-lg border border-zinc-700 text-zinc-400 font-bold transition-all");
            document.getElementById(`btn-${role}`).className = "role-btn glow-flow flex justify-between items-center px-4 py-3 rounded-lg border border-orange-500 bg-orange-500 text-black font-bold transition-all";
        };

        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const extraInfo = document.getElementById('role-specific-input').value;
            
            // MASTER ADMIN BYPASS
            if (email === "admin@univolt.com" && pass === "UNI_99") {
                window.location.href = "admin.html";
                return;
            }

            document.getElementById('btn-text').style.opacity = '0';
            document.getElementById('loader').style.display = 'block';

            try {
                if (!isLogin) {
                    // 1. REGISTER: Create Auth Account
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    
                    // 2. REQUEST: Save "Pending" status to Realtime Database
                    await set(ref(db, 'users/' + res.user.uid), {
                        email: email,
                        role: selectedRole,
                        extra: extraInfo,
                        status: "pending"
                    });

                    alert("Request Sent Successfully! Please wait for Admin approval.");
                    location.reload();
                } else {
                    // 3. LOGIN: Authenticate and check status
                    const res = await signInWithEmailAndPassword(auth, email, pass);
                    const dbRef = ref(db);
                    const snapshot = await get(child(dbRef, `users/${res.user.uid}`));

                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        
                        if (userData.status === "approved") {
                            // REDIRECT based on role
                            if (userData.role === 'unibro') window.location.href = "student.html";
                            else if (userData.role === 'unimate') window.location.href = "alumni.html";
                        } else {
                            // BLOCK if still pending
                            alert("Access Denied: Your account is still pending approval.");
                            await signOut(auth);
                            location.reload();
                        }
                    } else {
                        alert("User data not found in system.");
                    }
                }
            } catch (err) {
                alert("Protocol Error: " + err.message);
                document.getElementById('btn-text').style.opacity = '1';
                document.getElementById('loader').style.display = 'none';
            }
        };
    </script>
</body>
</html>
